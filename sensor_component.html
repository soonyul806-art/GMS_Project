<!-- sensor_component.html -->
<!DOCTYPE html>
<html>
  <body>
    <script>
      let sensorData = [];
      let isCollecting = false;
      let permissionGranted = false;

      async function requestPermissionIfNeeded() {
        // iOS 13 이상 권한 요청 필요
        if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
          try {
            const response = await DeviceMotionEvent.requestPermission();
            if (response === "granted") {
              permissionGranted = true;
            } else {
              alert("센서 권한이 필요합니다.");
            }
          } catch (err) {
            alert("권한 요청 중 오류 발생: " + err);
          }
        } else {
          // Android나 iOS 12 이하
          permissionGranted = true;
        }
      }

      function startSensorCollection(duration = 5000) {
        if (!permissionGranted) {
          alert("센서 권한이 필요합니다. 먼저 권한을 허용해주세요.");
          return;
        }

        if (isCollecting) return;

        sensorData = [];
        isCollecting = true;

        function handleMotion(event) {
          const dataPoint = {
            timestamp: Date.now(),
            accel: {
              x: event.acceleration.x,
              y: event.acceleration.y,
              z: event.acceleration.z,
            },
            accelIncludingGravity: {
              x: event.accelerationIncludingGravity.x,
              y: event.accelerationIncludingGravity.y,
              z: event.accelerationIncludingGravity.z,
            },
            rotationRate: {
              alpha: event.rotationRate.alpha,
              beta: event.rotationRate.beta,
              gamma: event.rotationRate.gamma,
            }
          };
          sensorData.push(dataPoint);
        }

        window.addEventListener("devicemotion", handleMotion);

        setTimeout(() => {
          window.removeEventListener("devicemotion", handleMotion);
          isCollecting = false;
          // 데이터를 부모 스트림릿으로 전송
          window.parent.postMessage({ type: "sensor_data", payload: sensorData }, "*");
        }, duration);
      }

      // 메시지 수신 대기
      window.addEventListener("message", async (event) => {
        if (event.data === "request_permission") {
          await requestPermissionIfNeeded();
        } else if (event.data === "start_collection") {
          startSensorCollection();
        }
      });
    </script>
  </body>
</html>
